<!-- src/app/components/appointment-list/appointment-list.component.html -->

<div class="card shadow border-0 rounded-4 overflow-hidden">
  <div class="card-header bg-gradient bg-primary text-white py-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div class="d-flex align-items-center gap-3">
        <i class="bi bi-calendar-check-fill fs-2"></i>
        <div>
          <h4 class="mb-0 fw-bold">All Appointments</h4>
          <small class="opacity-90">Manage and track patient appointments</small>
        </div>
      </div>

      <div class="d-flex gap-2 flex-wrap">
        <div class="position-relative">
          <i class="bi bi-search position-absolute top-50 start-3 translate-middle-y text-muted"></i>
          <input type="text" class="form-control ps-5" placeholder="Search" [(ngModel)]="search" (input)="filter()"
            style="min-width: 200px; border-radius: 12px;">
        </div>

        <select class="form-select" [(ngModel)]="statusFilter" (change)="filter()"
          style="min-width: 140px; border-radius: 12px;">
          <option value="all">All Status</option>
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
          <option value="complete">Complete</option>
          <option value="cancelled">Cancelled</option>
        </select>

        <ng-container *ngIf="isSuperAdmin">
          <select class="form-select" [(ngModel)]="hospitalFilter" (change)="filter()"
            style="min-width: 160px; border-radius: 12px;">
            <option [ngValue]="null">All Hospitals</option>
            <option *ngFor="let h of hospitals" [ngValue]="h.id">{{ h.name }}</option>
          </select>

          <select class="form-select" [(ngModel)]="divisionFilter" (change)="onDivisionChange()"
            style="min-width: 140px; border-radius: 12px;">
            <option [ngValue]="null">All Divisions</option>
            <option *ngFor="let d of divisions" [ngValue]="d.id">{{ d.nameEn }}</option>
          </select>

          <select class="form-select" [(ngModel)]="districtFilter" (change)="onDistrictChange()"
            style="min-width: 140px; border-radius: 12px;">
            <option [ngValue]="null">All Districts</option>
            <option *ngFor="let d of districts" [ngValue]="d.id">{{ d.nameEn }}</option>
          </select>

          <select class="form-select" [(ngModel)]="upazilaFilter" (change)="filter()"
            style="min-width: 140px; border-radius: 12px;">
            <option [ngValue]="null">All Upazilas</option>
            <option *ngFor="let u of upazilas" [ngValue]="u.id">{{ u.nameEn }}</option>
          </select>
        </ng-container>
      </div>
    </div>
  </div>


  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" style="width: 3.5rem; height: 3.5rem;"></div>
    <p class="mt-3 text-muted fw-medium">Loading appointments...</p>
  </div>

  <div *ngIf="!loading && filtered.length === 0" class="text-center py-5">
    <i class="bi bi-calendar-x fs-1 text-muted"></i>
    <p class="mt-3 text-muted fs-5">No appointments found</p>
  </div>


  <div class="table-responsive" *ngIf="filtered.length > 0">
    <table class="table table-hover align-middle mb-0">
      <thead class="bg-light">
        <tr>
          <th class="ps-4 fw-semibold text-dark">SL</th>
          <th class="fw-semibold text-dark">Patient</th>
          <th class="fw-semibold text-dark">Doctor</th>
          <th class="fw-semibold text-dark">Date & Time</th>
          <th class="fw-semibold text-dark">Status</th>
          <th class="fw-semibold text-dark">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let apt of paginated; let i = index">
          <td class="ps-4">{{ (page - 1) * pageSize + i + 1 }}</td>
          <td>
            <div class="fw-bold">{{ apt.patientName }}</div>
            <small class="text-muted">{{ apt.patientPhone }}</small>
            <div class="small text-muted" *ngIf="apt.patientAge || apt.patientGender">
              {{ apt.patientAge ? apt.patientAge + ' yrs' : '' }}
              {{ apt.patientGender ? '(' + apt.patientGender + ')' : '' }}
            </div>
            <div *ngIf="apt.reason" class="small text-info">Reason: {{ apt.reason }}</div>
          </td>
          <td>
            <div class="fw-bold">{{ apt.doctorName || 'N/A' }}</div>
            <small class="text-muted">{{ apt.doctorSpecialty }}</small>
          </td>
          <td>
            <div class="fw-bold">{{ apt.appointmentDate }}</div>
            <small class="text-muted">{{ apt.appointmentTime }}</small>
          </td>
          <td>
            <span class="badge rounded-pill" [ngClass]="{
               'bg-warning': apt.status === 'pending',
               'bg-success': apt.status === 'confirmed',
               'bg-primary': apt.status === 'complete',
               'bg-danger': apt.status === 'cancelled'
             }">{{ apt.status | titlecase }}</span>
          </td>
          <td>
            <div class="d-flex gap-2 mb-2">
              <button class="btn btn-sm btn-outline-info" (click)="viewDetails(apt.id!)" title="View Details">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn btn-sm btn-outline-primary" (click)="edit(apt.id!)" title="Edit">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" (click)="delete(apt.id!)" title="Delete">
                <i class="bi bi-trash"></i>
              </button>
              <button class="btn btn-sm btn-outline-secondary" (click)="printSlip(apt)" title="Print Slip">
                <i class="bi bi-printer"></i>
              </button>
            </div>

            <div class="btn-group btn-group-sm mb-2" *ngIf="apt.status !== 'cancelled' && apt.status !== 'complete'">
              <button class="btn btn-outline-success" (click)="changeStatus(apt, 'confirmed')"
                *ngIf="apt.status === 'pending'">Confirm</button>
              <button class="btn btn-outline-primary" (click)="changeStatus(apt, 'complete')"
                *ngIf="apt.status === 'confirmed'">Complete</button>
              <button class="btn btn-outline-danger" (click)="changeStatus(apt, 'cancelled')">Cancel</button>
            </div>

            <div *ngIf="isDoctor" class="mt-3 p-3 bg-light rounded-3 border border-success border-opacity-25">
              <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-clipboard-pulse text-success"></i>
                <label class="form-label mb-0 fw-semibold text-success small">Doctor's Note / Advice</label>
              </div>
              <textarea class="form-control form-control-sm mb-2 border-success border-opacity-50"
                [(ngModel)]="apt.notes" rows="3"
                placeholder="Add your medical notes, advice, or prescription details here..."
                style="resize: none;"></textarea>
              <button class="btn btn-sm btn-success w-100 d-flex align-items-center justify-content-center gap-2"
                (click)="saveNote(apt)">
                <i class="bi bi-save"></i>
                <span>Save Note</span>
              </button>
            </div>

            <div *ngIf="apt.notes && !isDoctor"
              class="mt-3 p-3 bg-success bg-opacity-10 rounded-3 border border-success border-opacity-25">
              <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-clipboard-check text-success"></i>
                <strong class="text-success small">Doctor's Advice:</strong>
              </div>
              <p class="mb-0 small text-dark">{{ apt.notes }}</p>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="card-footer bg-white py-3" *ngIf="filtered.length > 0">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div class="d-flex align-items-center gap-3">
        <span class="text-muted small">Show</span>
        <select class="form-select form-select-sm" [(ngModel)]="pageSize" (change)="onPageSizeChange()"
          style="width: 80px;">
          <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
        </select>
        <span class="text-muted small">entries</span>
      </div>

      <div class="text-muted small">
        Showing {{ ((page - 1) * pageSize) + 1 }} to
        {{ page * pageSize > filtered.length ? filtered.length : page * pageSize }}
        of {{ filtered.length }} entries
      </div>

      <nav>
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item" [class.disabled]="page === 1">
            <button class="page-link" (click)="page = page - 1" [disabled]="page === 1">
              Previous
            </button>
          </li>
          <li class="page-item" *ngFor="let num of totalPages" [class.active]="page === num">
            <button class="page-link" (click)="goToPage(num)">{{ num }}</button>
          </li>
          <li class="page-item" [class.disabled]="page === totalPages.length">
            <button class="page-link" (click)="page = page + 1" [disabled]="page === totalPages.length">
              Next
            </button>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>