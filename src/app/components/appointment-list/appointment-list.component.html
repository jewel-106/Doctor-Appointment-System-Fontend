<div class="card glass-card border-0 overflow-hidden">
  <div class="card-header border-0 py-4"
    style="background: linear-gradient(135deg, rgba(13, 148, 136, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%);">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div class="d-flex align-items-center gap-3">
        <div class="brand-logo rounded-circle d-flex align-items-center justify-content-center">
          <i class="bi bi-calendar-check-fill fs-4"></i>
        </div>
        <div>
          <h4 class="mb-0 fw-bold brand-text">Your Health Journey</h4>
          <small class="text-secondary">Track your wellness progress and upcoming visits</small>
        </div>
      </div>
      <div class="d-flex gap-2 flex-wrap glass p-2 rounded-4">
        <div class="position-relative">
          <i class="bi bi-search position-absolute top-50 start-3 translate-middle-y text-muted"></i>
          <input type="text" class="form-control ps-5 border-0 bg-white" placeholder="Search your history..."
            [(ngModel)]="search" (input)="filter()"
            style="min-width: 250px; border-radius: 12px; box-shadow: var(--shadow-sm);">
        </div>
        <select class="form-select border-0 bg-white" [(ngModel)]="statusFilter" (change)="filter()"
          style="min-width: 140px; border-radius: 12px; box-shadow: var(--shadow-sm);">
          <option value="all">Any Status</option>
          <option value="pending">Waiting</option>
          <option value="confirmed">Scheduled</option>
          <option value="complete">Finished</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
    </div>
    <div class="mt-4 d-flex gap-2 flex-wrap" *ngIf="isSuperAdmin">
      <select class="form-select glass border-0" [(ngModel)]="hospitalFilter" (change)="filter()"
        style="min-width: 180px; border-radius: 12px;">
        <option [ngValue]="null">Filter by Facility</option>
        <option *ngFor="let h of hospitals" [ngValue]="h.id">{{ h.name }}</option>
      </select>
      <select class="form-select glass border-0" [(ngModel)]="divisionFilter" (change)="onDivisionChange()"
        style="min-width: 140px; border-radius: 12px;">
        <option [ngValue]="null">Select Region</option>
        <option *ngFor="let d of divisions" [ngValue]="d.id">{{ d.nameEn }}</option>
      </select>
      <select class="form-select glass border-0" [(ngModel)]="districtFilter" (change)="onDistrictChange()"
        style="min-width: 140px; border-radius: 12px;">
        <option [ngValue]="null">Select City</option>
        <option *ngFor="let d of districts" [ngValue]="d.id">{{ d.nameEn }}</option>
      </select>
      <select class="form-select glass border-0" [(ngModel)]="upazilaFilter" (change)="filter()"
        style="min-width: 140px; border-radius: 12px;">
        <option [ngValue]="null">Select Area</option>
        <option *ngFor="let u of upazilas" [ngValue]="u.id">{{ u.nameEn }}</option>
      </select>
    </div>
  </div>
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" style="width: 3.5rem; height: 3.5rem;"></div>
    <p class="mt-3 text-muted fw-medium">Retrieving your care records...</p>
  </div>
  <div *ngIf="!loading && filtered.length === 0" class="text-center py-5">
    <i class="bi bi-calendar-x fs-1 text-muted"></i>
    <p class="mt-3 text-muted fs-5">No activities found yet</p>
  </div>
  <div class="table-responsive" *ngIf="filtered.length > 0">
    <table class="table table-hover align-middle mb-0">
      <thead class="bg-light">
        <tr>
          <th class="ps-4 fw-semibold text-dark">#</th>
          <th class="fw-semibold text-dark">Patient Details</th>
          <th class="fw-semibold text-dark">Attending Specialist</th>
          <th class="fw-semibold text-dark">Appointment Schedule</th>
          <th class="fw-semibold text-dark">Current Status</th>
          <th class="fw-semibold text-dark">Management</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let apt of paginated; let i = index">
          <td class="ps-4 text-muted">{{ (page - 1) * pageSize + i + 1 }}</td>
          <td>
            <div class="fw-bold">{{ apt.patientName }}</div>
            <small class="text-muted d-block"><i class="bi bi-telephone ms-0 me-1"></i>{{ apt.patientPhone }}</small>
            <div class="small text-muted" *ngIf="apt.patientAge || apt.patientGender">
              <span class="badge bg-light text-dark border-0 fw-normal me-1">{{ apt.patientAge }} yrs</span>
              <span class="badge bg-light text-dark border-0 fw-normal">{{ apt.patientGender }}</span>
            </div>
            <div *ngIf="apt.reason" class="small text-info mt-1">
              <i class="bi bi-info-circle me-1"></i>Reported Issue: {{ apt.reason }}
            </div>
          </td>
          <td>
            <div class="fw-bold text-primary">{{ apt.doctorName || 'To be assigned' }}</div>
            <small class="text-muted text-uppercase" style="font-size: 0.7rem; letter-spacing: 0.5px;">{{
              apt.doctorSpecialty }}</small>
          </td>
          <td>
            <div class="fw-bold"><i class="bi bi-calendar-event me-2 text-secondary"></i>{{ apt.appointmentDate }}</div>
            <div class="badge bg-light text-dark border fw-normal mt-1"><i class="bi bi-clock me-1"></i>{{
              apt.appointmentTime }}</div>
          </td>
          <td>
            <span class="badge rounded-pill px-3 py-2" [ngClass]="{
               'bg-warning text-dark': apt.status === 'pending',
               'bg-success': apt.status === 'confirmed',
               'bg-primary': apt.status === 'complete',
               'bg-danger': apt.status === 'cancelled'
             }">
              <i class="bi me-1" [ngClass]="{
               'bi-hourglass-split': apt.status === 'pending',
                'bi-calendar-check': apt.status === 'confirmed',
                'bi-check-all': apt.status === 'complete',
                'bi-x-circle': apt.status === 'cancelled'
             }"></i>
              {{ (apt.status === 'pending' ? 'Waiting' : apt.status === 'confirmed' ? 'Scheduled' : apt.status ===
              'complete' ? 'Finished' : 'Cancelled') }}
            </span>
          </td>
          <td>
            <div class="d-flex gap-2 mb-2">
              <button class="btn btn-sm btn-outline-info" (click)="viewDetails(apt.id!)" title="View Full Profile">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn btn-sm btn-outline-primary" (click)="edit(apt.id!)" title="Update Details"
                *ngIf="canChangeStatus(apt)">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" (click)="delete(apt.id!)" title="Remove Record"
                *ngIf="canChangeStatus(apt)">
                <i class="bi bi-trash"></i>
              </button>
              <button class="btn btn-sm btn-outline-secondary" (click)="printSlip(apt)" title="Print Care Summary">
                <i class="bi bi-printer"></i>
              </button>
            </div>
            <div class="btn-group btn-group-sm mb-2"
              *ngIf="canChangeStatus(apt) && apt.status !== 'cancelled' && apt.status !== 'complete'">
              <button class="btn btn-success" (click)="changeStatus(apt, 'confirmed')"
                *ngIf="apt.status === 'pending'">Schedule Now</button>
              <button class="btn btn-primary" (click)="changeStatus(apt, 'complete')"
                *ngIf="apt.status === 'confirmed'">Mark as Finished</button>
              <button class="btn btn-outline-danger" (click)="changeStatus(apt, 'cancelled')">Cancel Visit</button>
            </div>
            <div *ngIf="isDoctor" class="mt-3 p-3 bg-light rounded-3 border border-success border-opacity-25">
              <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-clipboard-pulse text-success"></i>
                <label class="form-label mb-0 fw-semibold text-success small">Expert Medical Guidance</label>
              </div>
              <textarea class="form-control form-control-sm mb-2 border-success border-opacity-50"
                [(ngModel)]="apt.notes" rows="3" placeholder="Share your advice or prescription details here..."
                style="resize: none;"></textarea>
              <button class="btn btn-sm btn-success w-100 d-flex align-items-center justify-content-center gap-2"
                (click)="saveNote(apt)">
                <i class="bi bi-save"></i>
                <span>Save Advice</span>
              </button>
            </div>
            <div *ngIf="apt.notes && !isDoctor"
              class="mt-3 p-3 bg-success bg-opacity-10 rounded-3 border border-success border-opacity-25">
              <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-chat-heart text-success"></i>
                <strong class="text-success small">Words from your Specialist:</strong>
              </div>
              <p class="mb-0 small text-dark">{{ apt.notes }}</p>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="card-footer bg-white py-3" *ngIf="filtered.length > 0">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div class="d-flex align-items-center gap-3">
        <span class="text-muted small">Show</span>
        <select class="form-select form-select-sm" [(ngModel)]="pageSize" (change)="onPageSizeChange()"
          style="width: 80px;">
          <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
        </select>
        <span class="text-muted small">entries</span>
      </div>
      <div class="text-muted small">
        Showing {{ ((page - 1) * pageSize) + 1 }} to
        {{ page * pageSize > filtered.length ? filtered.length : page * pageSize }}
        of {{ filtered.length }} entries
      </div>
      <nav>
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item" [class.disabled]="page === 1">
            <button class="page-link" (click)="page = page - 1" [disabled]="page === 1">
              Previous
            </button>
          </li>
          <li class="page-item" *ngFor="let num of totalPages" [class.active]="page === num">
            <button class="page-link" (click)="goToPage(num)">{{ num }}</button>
          </li>
          <li class="page-item" [class.disabled]="page === totalPages.length">
            <button class="page-link" (click)="page = page + 1" [disabled]="page === totalPages.length">
              Next
            </button>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>